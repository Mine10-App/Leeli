<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Leave Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background: #eef2f7; margin: 0; padding: 20px; }
  h2 { text-align: center; }
  .filters { text-align: center; margin-bottom: 20px; }
  .filters input, .filters button { padding: 5px; margin: 0 5px; }
  table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; }
  th { background: #007bff; color: white; }
  button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
  .apply-btn { background: #28a745; color: white; }
  .apply-btn.applied { background: gray; cursor: default; }
  .delete-btn { background: red; color: white; }
</style>
</head>
<body>

<h2>Leave Entries</h2>

<div class="filters">
  <label>From: <input type="date" id="fromDate"></label>
  <label>To: <input type="date" id="toDate"></label>
  <label>Staff: <input type="text" id="filterStaff" placeholder="Name"></label>
  <button onclick="filterReports()">Filter</button>
  <button onclick="loadReports()">Reset</button>
</div>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Staff</th>
      <th>RC No</th>
      <th>Leave</th>
      <th>Reason</th>
      <th>Duty</th>
      <th>Submitted</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="reportList"></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="sca.js"></script>
<script src="aqj.js"></script>

<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const reportList = document.getElementById("reportList");

// Get current user & WP
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
const currentWP = localStorage.getItem("currentWP");

if(!currentUser || !currentWP){
  alert("Please login first!");
  window.location.href = "WPLogin.html";
}

// Render entries
function renderEntries(snapshot, staffFilter = "") {
  reportList.innerHTML = "";
  snapshot.forEach(docSnap => {
    const d = docSnap.data();

    // Only show entries for the logged-in WP
    if(d.WP !== currentWP) return;

    // Filter by staff if provided
    if(staffFilter && !d.staff.toLowerCase().includes(staffFilter.toLowerCase())) return;

    const status = d.status || "pending";
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.date}</td>
      <td>${d.staff}</td>
      <td>${d.rcNo}</td>
      <td>${d.leave}</td>
      <td>${d.reason}</td>
      <td>${d.duty}</td>
      <td>${d.submitTime || "-"}</td>
      <td>${status}</td>
      <td>
        <button class="apply-btn ${status==='applied'?'applied':''}" ${status==='applied'?'disabled':''}>Apply</button>
        <button class="delete-btn">Delete</button>
      </td>
    `;

    const applyBtn = row.querySelector(".apply-btn");
    const deleteBtn = row.querySelector(".delete-btn");

    applyBtn.onclick = async () => {
      if(status !== "applied"){
        await db.collection("leave_entries").doc(docSnap.id).update({ status: "applied" });
        loadReports();
      }
    };

    deleteBtn.onclick = async () => {
      if(confirm("Delete this entry?")){
        await db.collection("leave_entries").doc(docSnap.id).delete();
        loadReports();
      }
    };

    reportList.appendChild(row);
  });
}

// Load all entries
function loadReports(){
  db.collection("leave_entries").orderBy("timestamp","desc").get()
    .then(snapshot => renderEntries(snapshot))
    .catch(err => {
      console.error("Error loading reports:", err);
      reportList.innerHTML = "<tr><td colspan='9'>Error loading reports.</td></tr>";
    });
}

// Filter by date and staff
function filterReports(){
  const fromDate = document.getElementById("fromDate").value;
  const toDate = document.getElementById("toDate").value;
  const staffFilter = document.getElementById("filterStaff").value;

  db.collection("leave_entries").orderBy("timestamp","desc").get()
    .then(snapshot => {
      let filteredSnapshot = snapshot.docs;

      if(fromDate && toDate){
        const from = new Date(fromDate);
        const to = new Date(toDate);
        to.setHours(23,59,59,999);
        filteredSnapshot = filteredSnapshot.filter(docSnap => {
          const ts = docSnap.data().timestamp?.toDate ? docSnap.data().timestamp.toDate() : new Date(docSnap.data().timestamp);
          return ts >= from && ts <= to;
        });
      }

      renderEntries({ forEach: fn => filteredSnapshot.forEach(fn) }, staffFilter);
    })
    .catch(err => {
      console.error("Error filtering reports:", err);
      reportList.innerHTML = "<tr><td colspan='9'>Error filtering reports.</td></tr>";
    });
}

// Initial load
loadReports();
</script>
</body>
</html>
