<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Leave Form - Today's Entries</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f6fa; margin: 0; padding: 20px; display: flex; justify-content: center; }
  .container { display: flex; gap: 30px; width: 95%; max-width: 1200px; }

  .form-container, .entry-list { flex: 1; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
  form .form-row { display: flex; align-items: center; margin-bottom: 12px; }
  form label { width: 120px; font-weight: bold; margin-right: 10px; }
  form input, form select { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
  form input[type="submit"] { background: #007bff; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; }
  form input[type="submit"]:hover { background: #0056b3; }

  h2 { text-align: center; margin-bottom: 15px; }
  .entry-header, .entry-row { display: flex; gap: 10px; padding: 6px 0; align-items: center; }
  .entry-header div { font-weight: bold; flex: 1; text-align: center; border-bottom: 2px solid #007bff; }
  .entry-row div { flex: 1; text-align: center; background: #f1f1f1; padding: 5px; border-radius: 5px; font-size: 14px; }
  .delete-btn { background: red; color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; }
  .user-info { text-align: center; margin-bottom: 10px; font-weight: bold; color: #333; }
</style>
</head>
<body>

<div class="container">

  <!-- Form -->
  <div class="form-container">
    <h2>Leave Form</h2>
    <form id="leaveForm">
      <div class="form-row">
        <label for="myDate">Date:</label>
        <input type="date" id="myDate" required>
      </div>
      <div class="form-row">
        <label for="recipient">Name:</label>
        <input type="text" id="recipient" readonly>
      </div>
      <div class="form-row">
        <label for="RcNo">RCNo:</label>
        <input type="text" id="RcNo" readonly>
      </div>
      <div class="form-row">
        <label for="LType">Leave Type:</label>
        <select id="LType" required>
          <option value="">--Choose--</option>
          <option value="Sick Leave">Sick Leave</option>
          <option value="FRL">FRL</option>
          
        </select>
      </div>
      <div class="form-row">
        <label for="Reason">Reason:</label>
        <select id="Reason" required>
          <option value="">--Choose--</option>
        </select>
      </div>
      <div class="form-row">
        <label for="DutyTime">Duty Time:</label>
        <input type="time" id="DutyTime" required>
      </div>
      <input type="submit" value="Add Leave Entry">
    </form>
    <div id="message" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Today's Entries -->
  <div class="entry-list">
    <h2>Current payrol Entries</h2>
    <div class="user-info" id="userInfo"></div>
    <div class="entry-header">
      <div>Date</div>
      <div>Staff</div>
      <div>Leave</div>
      <div>Duty</div>
      <div>Action</div>
    </div>
    <div id="todayList"></div>
  </div>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="sca.js"></script> 
<script src="aqj.js"></script> 

<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Logged-in user
const currentUser = localStorage.getItem("currentUser") || "";
const loggedInUser = users.find(u => u.name === currentUser);

const rcInput = document.getElementById("RcNo");
const recipientInput = document.getElementById("recipient");
const leaveSelect = document.getElementById("LType");
const reasonSelect = document.getElementById("Reason");
const dateInput = document.getElementById("myDate");
const dutyInput = document.getElementById("DutyTime");
const form = document.getElementById("leaveForm");
const messageDiv = document.getElementById("message");
const todayList = document.getElementById("todayList");
const userInfo = document.getElementById("userInfo");

// Auto-fill recipient and RCNo
if(loggedInUser){
  recipientInput.value = loggedInUser.name;
  rcInput.value = loggedInUser.rcNo;
  userInfo.innerText = "Showing entries for: " + loggedInUser.name;
} else {
  recipientInput.value = "";
  rcInput.value = "";
  userInfo.innerText = "⚠️ No logged-in user found!";
  console.error("Logged-in user not found in users array");
}

// Reason options
const sickReasons = ["Abdominal pain","Accident Injuries","Allergic","Anxiety","Arthritis","Asthma","Arm Pain","Back Pain","Body Pain","Leg Pain","Ear Pain","Bacterial Conjunctivitis","Common Cold / Flu and Fever","Dental issue","Depression","Dizziness","Dirrhea","Eye Infection","Fatigue","Gastric","Headache","Hernia","Infection","Joint Pain","Medical Appointments","Menstrual Pain","Migraines","Minor surgery","Muscle Pain","Pharyngitis","Physical injuries","Senile Cataract","Spasrnodic Torticollis","Stomach upset","Tonsillitis","URTI","Viral Conjunctivitis"];
const frlReasons = ["Moving to a new House","To attend a family event","To take family to and from Island","Urgent work at home","Baby sitting","Parent-Teacher meeting","House Renovation","Family member sick/admitted","Court appearance","To attend a funeral"];

// Populate Reason dynamically
leaveSelect.addEventListener("change", ()=>{
  reasonSelect.innerHTML = '<option value="">--Choose--</option>';
  let reasons = [];
  if(leaveSelect.value === "Sick Leave") reasons = sickReasons;
  else if(leaveSelect.value === "FRL") reasons = frlReasons;
  reasons.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    reasonSelect.appendChild(opt);
  });
});

// Prevent back date selection
dateInput.min = new Date().toISOString().split("T")[0];

// Submit form
form.addEventListener("submit", async e=>{
  e.preventDefault();
  messageDiv.innerText = "";

  const dateVal = dateInput.value;
  const leaveVal = leaveSelect.value;
  const reasonVal = reasonSelect.value;
  const dutyVal = dutyInput.value;

  if(!dateVal || !leaveVal || !reasonVal || !dutyVal) return;

  // Check Sick Leave late report (time diff < 2 hours)
  if(leaveVal === "Sick Leave"){
    const now = new Date();
    const [dutyH, dutyM] = dutyVal.split(":").map(Number);
    const dutyDateTime = new Date(dateVal);
    dutyDateTime.setHours(dutyH, dutyM, 0, 0);

    const diffMs = dutyDateTime - now;
    const diffHrs = diffMs / (1000 * 60 * 60);

    if(diffHrs < 2){
      messageDiv.innerText = "⚠️ Late Report: Less than 2 hours to duty time!";
      return;
    }
  }

  // Save to Firestore
  try {
    await db.collection("leave_entries").add({
      date: dateVal,
      staff: loggedInUser.name,
      rcNo: loggedInUser.rcNo,
      leave: leaveVal,
      reason: reasonVal,
      duty: dutyVal,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    form.reset();
    recipientInput.value = loggedInUser.name;
    rcInput.value = loggedInUser.rcNo;
  } catch(err){
    console.error("Error adding document:", err);
  }
});

// Load today's entries (only for current user)
function loadTodayEntries(){
  const today = new Date().toISOString().split("T")[0];
  if(!loggedInUser) return;
  db.collection("leave_entries")
    .where("date","==",today)
    .where("staff","==",loggedInUser.name)  // ✅ filter by current user
    .onSnapshot(snapshot=>{
      todayList.innerHTML = "";
      snapshot.forEach(docSnap=>{
        const d = docSnap.data();
        const row = document.createElement("div");
        row.className="entry-row";
        row.innerHTML = `
          <div>${d.date}</div>
          <div>${d.staff}</div>
          <div>${d.leave}</div>
          <div>${d.duty}</div>
          <div><button class="delete-btn" data-id="${docSnap.id}">X</button></div>
        `;
        todayList.appendChild(row);
      });

      todayList.querySelectorAll(".delete-btn").forEach(btn=>{
        btn.onclick = async ()=>{
          if(confirm("Are you sure you want to delete this entry?")){
            try { await db.collection("leave_entries").doc(btn.dataset.id).delete(); }
            catch(err){ console.error("Delete failed:", err); }
          }
        };
      });
    }, err=>console.error("Snapshot error:", err));
}

// Initialize
loadTodayEntries();
</script>

</body>
</html>


