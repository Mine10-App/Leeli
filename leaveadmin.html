<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Leave Admin Entry</title>
<style>
  body { font-family: Arial, sans-serif; background: #eef2f7; margin: 0; padding: 20px; }
  h2 { text-align:center; }

  .container { max-width: 1200px; margin: 0 auto; }

  form { 
    background: white; 
    padding: 20px; 
    border-radius: 10px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    margin-bottom: 20px; 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap;
    align-items: flex-end;
  }
  form label { flex: 0 0 120px; font-weight: bold; }
  form select, form input { flex: 1 1 150px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
  form input[type="submit"] { background: #007bff; color: white; border: none; cursor: pointer; flex: 0 0 120px; }
  form input[type="submit"]:hover { background: #0056b3; }

  table {
    width: 100%; 
    border-collapse: collapse; 
    background: white; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
  }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; }
  th { background: #007bff; color: white; }

  th.staff-col, td.staff-col { width: 180px; }
  th.reason-col, td.reason-col { width: 220px; }

  button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
  .apply-btn { background: #28a745; color: white; }
  .apply-btn.applied { background: gray; cursor: default; }
  .delete-btn { background: red; color: white; }

  @media (max-width: 768px) {
    form { flex-direction: column; align-items: stretch; }
    form label { flex: none; }
    form input, form select, form input[type="submit"] { flex: none; width: 100%; }
  }
</style>
</head>
<body>
<div class="container">
  <h2>Leave Admin Entry</h2>

  <form id="leaveForm">
    <label for="staffSelect">Staff:</label>
    <select id="staffSelect" required>
      <option value="">--Select Staff--</option>
    </select>

    <label for="LType">Leave Type:</label>
    <select id="LType" required>
      <option value="">--Choose--</option>
      <option value="Sick Leave">Sick Leave</option>
      <option value="FRL">FRL</option>
      <option value="Absent">Absent</option>
    </select>

    <label for="Reason">Reason:</label>
    <select id="Reason" required>
      <option value="">--Choose--</option>
    </select>

    <label for="DutyTime">Duty Time:</label>
    <input type="time" id="DutyTime" required>

    <input type="submit" value="Add Leave">
  </form>

  <table>
    <thead>
      <tr>
        <th>Staff</th>
        <th>RC No</th>
        <th>Leave</th>
        <th class="reason-col">Reason</th>
        <th>Duty</th>
        <th>Submitted</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="reportList">
      <tr><td colspan="8">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="sca.js"></script>
<script src="aqj.js"></script>

<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Elements
const staffSelect = document.getElementById("staffSelect");
const leaveSelect = document.getElementById("LType");
const reasonSelect = document.getElementById("Reason");
const dutyInput = document.getElementById("DutyTime");
const form = document.getElementById("leaveForm");
const reportList = document.getElementById("reportList");

// Populate staff dropdown from aqj.js users array
users.forEach(u => {
  const opt = document.createElement("option");
  opt.value = u.name;
  opt.textContent = u.name;
  staffSelect.appendChild(opt);
});

// Reason options
const sickReasons = ["Abdominal pain","Accident Injuries","Allergic","Anxiety","Arthritis","Asthma","Arm Pain","Back Pain","Body Pain","Leg Pain","Ear Pain","Bacterial Conjunctivitis","Common Cold / Flu and Fever","Dental issue","Depression","Dizziness","Dirrhea","Eye Infection","Fatigue","Gastric","Headache","Hernia","Infection","Joint Pain","Medical Appointments","Menstrual Pain","Migraines","Minor surgery","Muscle Pain","Pharyngitis","Physical injuries","Senile Cataract","Spasrnodic Torticollis","Stomach upset","Tonsillitis","URTI","Viral Conjunctivitis"];
const frlReasons = ["Moving to a new House","To attend a family event","To take family to and from Island","Urgent work at home","Baby sitting","Parent-Teacher meeting","House Renovation","Family member sick/admitted","Court appearance","To attend a funeral"];

// Populate Reason dynamically
leaveSelect.addEventListener("change", ()=>{
  reasonSelect.innerHTML = '<option value="">--Choose--</option>';
  let reasons = [];
  if(leaveSelect.value === "Sick Leave") reasons = sickReasons;
  else if(leaveSelect.value === "FRL") reasons = frlReasons;
  reasons.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    reasonSelect.appendChild(opt);
  });
});

// Submit form
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const staffName = staffSelect.value;
  const staffObj = users.find(u=>u.name===staffName);
  const leaveVal = leaveSelect.value;
  const reasonVal = reasonSelect.value;
  const dutyVal = dutyInput.value;

  if(!staffName || !leaveVal || !reasonVal || !dutyVal) return;

  const now = new Date();
  const submitTime = now.toLocaleTimeString();

  try {
    await db.collection("leave_entries").add({
      date: now.toISOString().split("T")[0],
      staff: staffName,
      rcNo: staffObj.rcNo,
      leave: leaveVal,
      reason: reasonVal,
      duty: dutyVal,
      submitTime: submitTime,
      status: "pending",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    form.reset();
  } catch(err){
    console.error("Error adding document:", err);
  }
});

// Load today's entries
function loadReports(){
  const today = new Date().toISOString().split("T")[0];
  db.collection("leave_entries")
    .where("date","==",today)
    .orderBy("timestamp","desc")
    .onSnapshot(snapshot=>{
      reportList.innerHTML = "";
      snapshot.forEach(docSnap=>{
        const d = docSnap.data();
        const row = document.createElement("tr");
        const status = d.status || "pending";

        row.innerHTML = `
          <td class="staff-col">${d.staff}</td>
          <td>${d.rcNo}</td>
          <td>${d.leave}</td>
          <td class="reason-col">${d.reason}</td>
          <td>${d.duty}</td>
          <td>${d.submitTime || "-"}</td>
          <td>${status}</td>
          <td>
            <button class="apply-btn ${status==='applied'?'applied':''}" ${status==='applied'?'disabled':''}>Apply</button>
            <button class="delete-btn">Delete</button>
          </td>
        `;

        const applyBtn = row.querySelector(".apply-btn");
        const deleteBtn = row.querySelector(".delete-btn");

        applyBtn.onclick = async ()=>{
          if(status!=="applied"){
            await db.collection("leave_entries").doc(docSnap.id).update({ status:"applied" });
          }
        };

        deleteBtn.onclick = async ()=>{
          if(confirm("Delete this entry?")){
            await db.collection("leave_entries").doc(docSnap.id).delete();
          }
        };

        reportList.appendChild(row);
      });
    });
}

// Initialize
loadReports();
</script>
</body>
</html>
