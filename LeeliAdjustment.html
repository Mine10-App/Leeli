<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pending Requests Approval</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, Roboto, sans-serif;
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
  min-height: 100vh;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  padding-bottom: 20px;
  border-bottom: 2px solid rgba(0, 119, 204, 0.1);
}

.header h1 {
  color: #1a365d;
  font-size: 28px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 12px;
}

.header h1::before {
  content: "üìã";
  font-size: 24px;
}

.filter-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 28px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 119, 204, 0.15);
}

.filter-card h3 {
  color: #1a365d;
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.filter-card h3::before {
  content: "‚öôÔ∏è";
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.filter-group label {
  font-weight: 500;
  color: #4a5568;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.filter-group label::before {
  content: "‚Ä¢";
  color: #0077cc;
}

.filter-control {
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 14px;
  transition: all 0.3s ease;
  background: white;
}

.filter-control:focus {
  outline: none;
  border-color: #0077cc;
  box-shadow: 0 0 0 3px rgba(0, 119, 204, 0.1);
}

.filter-actions {
  display: flex;
  align-items: center;
  gap: 16px;
  padding-top: 20px;
  border-top: 1px solid #e2e8f0;
}

.btn {
  padding: 12px 28px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, #0077cc 0%, #005fa3 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 119, 204, 0.3);
}

.btn-primary::before {
  content: "üîç";
}

.btn-secondary {
  background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
  color: #4a5568;
  border: 2px solid #cbd5e0;
}

.btn-secondary:hover {
  background: #e2e8f0;
  transform: translateY(-2px);
}

.btn-secondary::before {
  content: "üîÑ";
}

.active-filters {
  flex: 1;
  padding: 12px 20px;
  background: #f0f9ff;
  border-radius: 10px;
  border: 2px solid #e6f7ff;
  font-size: 14px;
  color: #2d3748;
}

.active-filters strong {
  color: #0077cc;
}

.data-card {
  background: white;
  border-radius: 16px;
  padding: 28px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 119, 204, 0.15);
  overflow: hidden;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #718096;
  font-size: 16px;
}

.loading::before {
  content: "‚è≥";
  display: block;
  font-size: 32px;
  margin-bottom: 16px;
}

.table-container {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 1000px;
}

thead {
  background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
}

th {
  padding: 16px 20px;
  text-align: left;
  font-weight: 600;
  color: #2d3748;
  border-bottom: 2px solid #e2e8f0;
  font-size: 14px;
  white-space: nowrap;
}

th:first-child {
  border-top-left-radius: 12px;
}

th:last-child {
  border-top-right-radius: 12px;
}

td {
  padding: 20px;
  border-bottom: 1px solid #e2e8f0;
  vertical-align: middle;
  color: #4a5568;
}

tbody tr {
  transition: all 0.3s ease;
}

tbody tr:hover {
  background-color: #f7fafc;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

/* Color codes for reasons */
.reason-sick {
  border-left: 4px solid #fc8181;
  background: linear-gradient(to right, #fff5f5 0%, white 100%);
}

.reason-duty {
  border-left: 4px solid #f6ad55;
  background: linear-gradient(to right, #fffaf0 0%, white 100%);
}

.reason-fine {
  border-left: 4px solid #68d391;
  background: linear-gradient(to right, #f0fff4 0%, white 100%);
}

.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-pending {
  background: #fed7d7;
  color: #c53030;
}

.status-sentToHR {
  background: #bee3f8;
  color: #2b6cb0;
}

.actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.action-btn {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-apply {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  color: white;
}

.btn-apply::before {
  content: "‚úì";
}

.btn-apply:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
}

.btn-sendHR {
  background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
  color: white;
}

.btn-sendHR::before {
  content: "üì§";
}

.btn-sendHR:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(214, 158, 46, 0.3);
}

/* Chat Comment System */
.comment-section {
  position: relative;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #e2e8f0;
}

.comment-toggle {
  background: none;
  border: none;
  color: #0077cc;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s;
}

.comment-toggle:hover {
  background: #f0f9ff;
}

.comment-toggle::before {
  content: "üí¨";
}

.comment-container {
  display: none;
  margin-top: 10px;
  background: #f8fafc;
  border-radius: 12px;
  padding: 16px;
  border: 1px solid #e2e8f0;
  max-height: 300px;
  overflow-y: auto;
}

.comment-container.show {
  display: block;
  animation: slideDown 0.3s ease;
}

.chat-messages {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
  max-height: 200px;
  overflow-y: auto;
  padding-right: 8px;
}

.chat-message {
  display: flex;
  gap: 10px;
  animation: fadeIn 0.3s ease;
}

.chat-message.sent {
  flex-direction: row-reverse;
}

.chat-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #0077cc 0%, #005fa3 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
}

.chat-avatar.user {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
}

.message-bubble {
  max-width: 70%;
  padding: 10px 14px;
  border-radius: 18px;
  position: relative;
  word-break: break-word;
}

.message-bubble.received {
  background: white;
  border: 1px solid #e2e8f0;
  border-bottom-left-radius: 4px;
}

.message-bubble.sent {
  background: linear-gradient(135deg, #0077cc 0%, #005fa3 100%);
  color: white;
  border-bottom-right-radius: 4px;
}

.message-time {
  font-size: 11px;
  color: #a0aec0;
  margin-top: 4px;
  text-align: right;
}

.message-bubble.sent .message-time {
  color: rgba(255, 255, 255, 0.8);
}

.message-bubble.received .message-time {
  color: #718096;
}

.chat-input-container {
  display: flex;
  gap: 8px;
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 24px;
  font-size: 14px;
  resize: none;
  min-height: 44px;
  max-height: 100px;
  line-height: 1.4;
  transition: all 0.3s ease;
  font-family: inherit;
}

.chat-input:focus {
  outline: none;
  border-color: #0077cc;
  box-shadow: 0 0 0 3px rgba(0, 119, 204, 0.1);
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #0077cc 0%, #005fa3 100%);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.send-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 119, 204, 0.3);
}

.send-btn::before {
  content: "‚û§";
  font-size: 14px;
  transform: rotate(90deg);
}

.no-comments {
  text-align: center;
  padding: 20px;
  color: #a0aec0;
  font-style: italic;
  font-size: 14px;
}

.no-comments::before {
  content: "üí≠";
  display: block;
  font-size: 24px;
  margin-bottom: 8px;
}

.results-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  margin-top: 20px;
  font-size: 14px;
  color: #4a5568;
}

.no-results {
  text-align: center;
  padding: 60px 20px;
  color: #a0aec0;
}

.no-results::before {
  content: "üì≠";
  font-size: 48px;
  display: block;
  margin-bottom: 20px;
}

/* Animations */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive design */
@media (max-width: 768px) {
  body {
    padding: 16px;
  }
  
  .header {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }
  
  .filter-grid {
    grid-template-columns: 1fr;
  }
  
  .filter-actions {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
  
  .active-filters {
    width: 100%;
  }
  
  .data-card {
    padding: 16px;
  }
  
  .table-container {
    border-radius: 8px;
  }
  
  .message-bubble {
    max-width: 85%;
  }
}
</style>
</head>
<body>
<div class="header">
  <h1>Pending Requests Approval</h1>
  <div class="results-info" id="resultsInfo" style="display:none">
    <span id="resultCount">0 results</span>
    <span id="filterStatus">No filters applied</span>
  </div>
</div>

<!-- Filter Card -->
<div class="filter-card">
  <h3>Filter Requests</h3>
  
  <div class="filter-grid">
    <div class="filter-group">
      <label for="filterDate">Date</label>
      <input type="date" id="filterDate" class="filter-control">
    </div>
    
    <div class="filter-group">
      <label for="filterReason">Reason</label>
      <select id="filterReason" class="filter-control">
        <option value="">All Reasons</option>
        <option value="Sick Leave">Sick Leave</option>
        <option value="DutyChange">Duty Change</option>
        <option value="Fine remove">Fine Remove</option>
        <option value="Other">Other</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="filterStaff">Staff Search</label>
      <input type="text" id="filterStaff" class="filter-control" placeholder="Search by name or RC number...">
    </div>
    
    <div class="filter-group">
      <label for="filterStatusSelect">Status</label>
      <select id="filterStatusSelect" class="filter-control">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="sentToHR">Sent to HR</option>
      </select>
    </div>
  </div>
  
  <div class="filter-actions">
    <button onclick="applyFilters()" class="btn btn-primary" id="applyFilterBtn">
      Apply Filters
    </button>
    <button onclick="resetFilters()" class="btn btn-secondary">
      Reset All Filters
    </button>
    <div class="active-filters" id="activeFilters">
      <strong>Active Filters:</strong> None
    </div>
  </div>
</div>

<!-- Data Card -->
<div class="data-card">
  <div id="pendingList" class="loading">Loading requests...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="./fireatt.js"></script>
<script>
var attApp = !firebase.apps.some(app => app.name === 'attApp')
  ? firebase.initializeApp(window.firebaseConfigAtten || {}, 'attApp')
  : firebase.app('attApp');

var attDb = attApp.firestore();
window.attDb = attDb;

// Track current user (you can replace this with actual authentication)
var currentUser = {
  name: 'Admin',
  initials: 'AD'
};

// Filter state management
var activeFilters = {
  date: null,
  reason: '',
  staff: '',
  status: ''
};

function loadFiltersFromStorage() {
  try {
    var savedFilters = localStorage.getItem('pendingRequestsFilters');
    if (savedFilters) {
      activeFilters = JSON.parse(savedFilters);
      
      // Restore filter UI
      if (activeFilters.date) {
        document.getElementById('filterDate').value = activeFilters.date;
      }
      if (activeFilters.reason) {
        document.getElementById('filterReason').value = activeFilters.reason;
      }
      if (activeFilters.staff) {
        document.getElementById('filterStaff').value = activeFilters.staff;
      }
      if (activeFilters.status) {
        document.getElementById('filterStatusSelect').value = activeFilters.status;
      }
      
      updateActiveFiltersDisplay();
    }
  } catch (e) {
    console.log('No saved filters or error loading:', e);
  }
}

function saveFiltersToStorage() {
  localStorage.setItem('pendingRequestsFilters', JSON.stringify(activeFilters));
}

function escapeHtml(s){ 
  return (s||'').toString()
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

var pendingListEl = document.getElementById('pendingList');
var resultsInfoEl = document.getElementById('resultsInfo');
var resultCountEl = document.getElementById('resultCount');
var filterStatusEl = document.getElementById('filterStatus');

function applyFilters() {
  var dateInput = document.getElementById('filterDate').value;
  var reasonInput = document.getElementById('filterReason').value;
  var staffInput = document.getElementById('filterStaff').value.trim();
  var statusInput = document.getElementById('filterStatusSelect').value;
  
  // Update active filters
  activeFilters.date = dateInput || null;
  activeFilters.reason = reasonInput || '';
  activeFilters.staff = staffInput || '';
  activeFilters.status = statusInput || '';
  
  saveFiltersToStorage();
  updateActiveFiltersDisplay();
  loadPending();
  
  // Show notification
  showNotification('Filters applied successfully!', 'success');
}

function resetFilters() {
  // Clear filter inputs
  document.getElementById('filterDate').value = '';
  document.getElementById('filterReason').value = '';
  document.getElementById('filterStaff').value = '';
  document.getElementById('filterStatusSelect').value = '';
  
  // Clear active filters
  activeFilters.date = null;
  activeFilters.reason = '';
  activeFilters.staff = '';
  activeFilters.status = '';
  
  // Clear localStorage
  localStorage.removeItem('pendingRequestsFilters');
  
  updateActiveFiltersDisplay();
  loadPending();
  
  // Show notification
  showNotification('All filters cleared!', 'info');
}

function updateActiveFiltersDisplay() {
  var filtersDisplay = document.getElementById('activeFilters');
  var activeFilterCount = 0;
  var filterTexts = [];
  
  if (activeFilters.date) {
    activeFilterCount++;
    filterTexts.push('Date: ' + activeFilters.date);
  }
  
  if (activeFilters.reason) {
    activeFilterCount++;
    filterTexts.push('Reason: ' + activeFilters.reason);
  }
  
  if (activeFilters.staff) {
    activeFilterCount++;
    filterTexts.push('Staff: ' + activeFilters.staff);
  }
  
  if (activeFilters.status) {
    activeFilterCount++;
    filterTexts.push('Status: ' + (activeFilters.status === 'pending' ? 'Pending' : 'Sent to HR'));
  }
  
  if (activeFilterCount > 0) {
    filtersDisplay.innerHTML = '<strong>Active Filters (' + activeFilterCount + '):</strong> ' + filterTexts.join(' ‚Ä¢ ');
    filtersDisplay.style.background = '#e6fffa';
    filtersDisplay.style.borderColor = '#81e6d9';
  } else {
    filtersDisplay.innerHTML = '<strong>Active Filters:</strong> None';
    filtersDisplay.style.background = '#f0f9ff';
    filtersDisplay.style.borderColor = '#e6f7ff';
  }
}

function showNotification(message, type) {
  // Create notification element
  var notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    border-radius: 10px;
    background: ${type === 'success' ? '#38a169' : '#4299e1'};
    color: white;
    font-weight: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  `;
  
  notification.innerHTML = `
    ${type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}
    ${message}
  `;
  
  document.body.appendChild(notification);
  
  // Remove after 3 seconds
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

// Chat functionality
function formatTime(date) {
  if (!date) return '';
  if (typeof date === 'string') date = new Date(date);
  if (typeof date === 'object' && date.toDate) date = date.toDate();
  
  return date.toLocaleTimeString('en-US', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: true 
  });
}

function formatDate(date) {
  if (!date) return '';
  if (typeof date === 'string') date = new Date(date);
  if (typeof date === 'object' && date.toDate) date = date.toDate();
  
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  if (date.toDateString() === today.toDateString()) {
    return 'Today';
  } else if (date.toDateString() === yesterday.toDateString()) {
    return 'Yesterday';
  } else {
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
    });
  }
}

function toggleChat(button) {
  const container = button.nextElementSibling;
  const isVisible = container.classList.contains('show');
  
  if (isVisible) {
    container.classList.remove('show');
    button.innerHTML = 'üí¨ Show Comments';
  } else {
    container.classList.add('show');
    button.innerHTML = 'üí¨ Hide Comments';
    // Scroll to bottom when opening
    setTimeout(() => {
      const chatMessages = container.querySelector('.chat-messages');
      if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }, 100);
  }
}

function renderChatMessages(comments, container) {
  const chatMessages = container.querySelector('.chat-messages');
  chatMessages.innerHTML = '';
  
  if (!comments || comments.length === 0) {
    chatMessages.innerHTML = '<div class="no-comments">No comments yet. Start the conversation!</div>';
    return;
  }
  
  // Sort comments by timestamp
  comments.sort((a, b) => {
    const timeA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp)) : new Date(0);
    const timeB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp)) : new Date(0);
    return timeA - timeB;
  });
  
  let currentDate = '';
  comments.forEach(comment => {
    const timestamp = comment.timestamp ? 
      (comment.timestamp.toDate ? comment.timestamp.toDate() : new Date(comment.timestamp)) : 
      new Date();
    
    // Add date separator if date changed
    const commentDate = formatDate(timestamp);
    if (commentDate !== currentDate) {
      currentDate = commentDate;
      const dateSeparator = document.createElement('div');
      dateSeparator.className = 'date-separator';
      dateSeparator.style.cssText = `
        text-align: center;
        margin: 10px 0;
        color: #a0aec0;
        font-size: 12px;
        font-weight: 500;
      `;
      dateSeparator.textContent = commentDate;
      chatMessages.appendChild(dateSeparator);
    }
    
    const isCurrentUser = comment.sender === 'admin' || comment.sender === currentUser.name;
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isCurrentUser ? 'sent' : 'received'}`;
    
    const avatarText = isCurrentUser ? currentUser.initials : (comment.sender || 'U').substring(0, 2).toUpperCase();
    
    messageDiv.innerHTML = `
      <div class="chat-avatar ${isCurrentUser ? 'user' : ''}">${avatarText}</div>
      <div class="message-bubble ${isCurrentUser ? 'sent' : 'received'}">
        <div class="message-text">${escapeHtml(comment.text)}</div>
        <div class="message-time">${formatTime(timestamp)}</div>
      </div>
    `;
    
    chatMessages.appendChild(messageDiv);
  });
  
  // Scroll to bottom
  setTimeout(() => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 100);
}

function sendMessage(input, requestId, container) {
  const message = input.value.trim();
  if (!message) return;
  
  // Get current comments
  const requestRef = attDb.collection('attRequests').doc(requestId);
  requestRef.get().then(doc => {
    const data = doc.data();
    const currentComments = data.comments || [];
    const oldComment = data.comment; // For backward compatibility
    
    // Add new message
    const newMessage = {
      text: message,
      sender: 'admin',
      timestamp: new Date()
    };
    
    // If there's an old comment, convert it
    if (oldComment && oldComment.trim() && currentComments.length === 0) {
      currentComments.push({
        text: oldComment,
        sender: 'system',
        timestamp: data.timeAdded || new Date()
      });
    }
    
    currentComments.push(newMessage);
    
    // Update Firestore
    requestRef.update({
      comments: currentComments,
      comment: message, // Keep for backward compatibility
      updatedAt: new Date()
    }).then(() => {
      // Clear input
      input.value = '';
      input.style.height = 'auto';
      
      // Update chat display
      renderChatMessages(currentComments, container);
      
      // Show notification
      showNotification('Message sent!', 'success');
    });
  });
}

function loadPending(){
  pendingListEl.innerHTML = '<div class="loading">Loading requests...</div>';
  resultsInfoEl.style.display = 'none';
  
  attDb.collection('attRequests')
       .where('status','!=','applied')
       .get()
    .then(function(snap){
      var docs = snap.docs.filter(function(doc){
        var data = doc.data();
        var matches = true;
        
        // Apply date filter
        if (activeFilters.date && data.date !== activeFilters.date) {
          matches = false;
        }
        
        // Apply reason filter
        if (activeFilters.reason && data.reason !== activeFilters.reason) {
          matches = false;
        }
        
        // Apply status filter
        if (activeFilters.status && data.status !== activeFilters.status) {
          matches = false;
        }
        
        // Apply staff search filter
        if (activeFilters.staff) {
          var searchTerm = activeFilters.staff.toLowerCase();
          var username = (data.username || '').toLowerCase();
          var rcno = (data.rcno || '').toLowerCase();
          
          if (!username.includes(searchTerm) && !rcno.includes(searchTerm)) {
            matches = false;
          }
        }
        
        return matches;
      });
      
      // Sort by timeAdded (newest first)
      docs.sort(function(a,b){
        var ta = a.data().timeAdded ? a.data().timeAdded.toDate() : 0;
        var tb = b.data().timeAdded ? b.data().timeAdded.toDate() : 0;
        return tb - ta;
      });
      
      renderPending(docs);
    })
    .catch(function(err){
      console.error(err);
      pendingListEl.innerHTML = '<div class="no-results">Error loading requests. Please try again.</div>';
    });
}

function renderPending(docs){
  if(!docs.length){ 
    pendingListEl.innerHTML = `
      <div class="no-results">
        No pending requests found
        ${activeFilters.date || activeFilters.reason || activeFilters.staff || activeFilters.status ? 
          ' matching the current filters' : ''}
        <br>
        <small style="margin-top: 10px; display: block;">
          Try adjusting your filters or check back later.
        </small>
      </div>
    `; 
    resultsInfoEl.style.display = 'none';
    return; 
  }
  
  var out = `
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>RC No.</th>
            <th>Date</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Remarks</th>
            <th>Added On</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  docs.forEach(function(d){
    var data = d.data();
    var t = data.timeAdded && data.timeAdded.toDate ? 
      data.timeAdded.toDate().toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : '';
    
    // Determine reason class
    var reasonClass = '';
    if(data.reason === 'Sick Leave') reasonClass = 'reason-sick';
    else if(data.reason === 'DutyChange') reasonClass = 'reason-duty';
    else if(data.reason === 'Fine remove') reasonClass = 'reason-fine';
    
    // Status badge
    var statusBadge = data.status === 'pending' 
      ? '<span class="status-badge status-pending">Pending</span>'
      : '<span class="status-badge status-sentToHR">Sent to HR</span>';
    
    out += `
      <tr class="${reasonClass}">
        <td><strong>${escapeHtml(data.username||'')}</strong></td>
        <td><code>${escapeHtml(data.rcno||'')}</code></td>
        <td>${escapeHtml(data.date||'')}</td>
        <td>${escapeHtml(data.reason||'')}</td>
        <td>${statusBadge}</td>
        <td>${escapeHtml(data.remarks||'')}</td>
        <td><small>${t}</small></td>
        <td>
          <div class="actions">
    `;
    
    // Action buttons based on status
    if(data.status === 'pending'){
      out += `
        <button class="action-btn btn-apply" data-id="${d.id}">
          Apply
        </button>
        <button class="action-btn btn-sendHR" data-id="${d.id}">
          Send to HR
        </button>
      `;
    } else if(data.status === 'sentToHR'){
      out += `
        <button class="action-btn btn-apply" data-id="${d.id}">
          Apply
        </button>
      `;
    }
    
    out += `
          </div>
    `;
    
    // Chat comment section
    const hasComments = data.comments && data.comments.length > 0;
    const commentCount = hasComments ? data.comments.length : 0;
    
    out += `
      <div class="comment-section">
        <button class="comment-toggle" onclick="toggleChat(this)" data-id="${d.id}">
          üí¨ ${hasComments ? `${commentCount} Comment${commentCount !== 1 ? 's' : ''}` : 'Add Comment'}
        </button>
        <div class="comment-container" data-id="${d.id}">
          <div class="chat-messages" data-id="${d.id}">
            <!-- Messages will be loaded here -->
          </div>
          <div class="chat-input-container">
            <textarea class="chat-input" 
                     placeholder="Type your comment..." 
                     rows="1"
                     data-id="${d.id}"></textarea>
            <button class="send-btn" onclick="sendMessage(this.previousElementSibling, '${d.id}', this.parentElement.parentElement)"></button>
          </div>
        </div>
      </div>
    </td></tr>
    `;
  });
  
  out += `
        </tbody>
      </table>
    </div>
  `;
  
  pendingListEl.innerHTML = out;
  
  // Update results info
  resultsInfoEl.style.display = 'flex';
  resultCountEl.textContent = `${docs.length} request${docs.length !== 1 ? 's' : ''} found`;
  filterStatusEl.textContent = activeFilters.date || activeFilters.reason || activeFilters.staff || activeFilters.status 
    ? 'Filters applied' 
    : 'No filters applied';

  // Load chat messages for each request
  docs.forEach(function(d) {
    const data = d.data();
    const container = document.querySelector(`.comment-container[data-id="${d.id}"]`);
    if (container) {
      renderChatMessages(data.comments || [], container);
    }
  });

  // Auto-resize textareas
  document.querySelectorAll('.chat-input').forEach(textarea => {
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    
    // Send on Ctrl+Enter
    textarea.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        const requestId = this.getAttribute('data-id');
        const container = this.closest('.comment-container');
        sendMessage(this, requestId, container);
      }
    });
  });

  // Attach event handlers for action buttons
  Array.from(document.querySelectorAll('.btn-apply')).forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = this.getAttribute('data-id');
      var confirmed = confirm('Are you sure you want to mark this request as applied?');
      if (confirmed) {
        attDb.collection('attRequests').doc(id).update({ 
          status: 'applied',
          updatedAt: new Date()
        }).then(function(){
          showNotification('Request marked as applied!', 'success');
          loadPending();
        });
      }
    });
  });
  
  Array.from(document.querySelectorAll('.btn-sendHR')).forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = this.getAttribute('data-id');
      var confirmed = confirm('Are you sure you want to send this request to HR?');
      if (confirmed) {
        attDb.collection('attRequests').doc(id).update({ 
          status: 'sentToHR',
          updatedAt: new Date()
        }).then(function(){
          showNotification('Request sent to HR!', 'success');
          loadPending();
        });
      }
    });
  });
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  loadFiltersFromStorage();
  loadPending();
  
  // Add Enter key support for filters
  document.getElementById('filterStaff').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      applyFilters();
    }
  });
  
  // Add real-time filtering on change for some inputs
  document.getElementById('filterReason').addEventListener('change', function() {
    if (this.value) applyFilters();
  });
  
  document.getElementById('filterStatusSelect').addEventListener('change', function() {
    if (this.value) applyFilters();
  });
});
</script>
</body>
</html>
