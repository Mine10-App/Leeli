<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Adjustment Viewer</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="fireatt.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #6c757d;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
      
      /* Status Colors */
      --pending-bg: #fff3cd;
      --pending-text: #856404;
      --applied-bg: #d1edff;
      --applied-text: #0c5460;
      --sent-hr-bg: #e6f7ff;
      --sent-hr-text: #0066cc;
      --action-required-bg: #ffe6e6;
      --action-required-text: #8b0000;
      
      /* Reason Colors */
      --sick-leave-bg: #ffe6e6;
      --sick-leave-text: #8b0000;
      --no-out-card-bg: #fff0cc;
      --no-out-card-text: #8a6d00;
      --duty-change-bg: #e6f7ff;
      --duty-change-text: #0066cc;
      --personal-bg: #f0e6ff;
      --personal-text: #4b0082;
      --training-bg: #e6ffe6;
      --training-text: #006600;
      
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: #333;
      line-height: 1.5;
      min-height: 100vh;
      padding: 20px;
      font-size: 14px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 25px;
      padding: 15px;
    }

    h1 {
      color: var(--primary);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
      position: relative;
      display: inline-block;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 70px;
      height: 3px;
      background: var(--primary);
      border-radius: 2px;
    }

    .subtitle {
      color: var(--secondary);
      font-size: 0.95rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius);
      padding: 15px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-3px);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      color: var(--secondary);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .total-requests .stat-value {
      color: var(--primary);
    }

    .pending-requests .stat-value {
      color: var(--warning);
    }

    .applied-requests .stat-value {
      color: var(--success);
    }

    .sent-hr-requests .stat-value {
      color: var(--sent-hr-text);
    }

    .card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 25px;
    }

    .card-header {
      background: var(--primary);
      color: white;
      padding: 14px 18px;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body {
      padding: 18px;
    }

    .filter-box {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
    }

    input, select, button, textarea {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      font-size: 0.85rem;
      transition: all 0.3s;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
      border: none;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      font-size: 0.85rem;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      position: relative;
      font-size: 0.9rem;
    }

    th::after {
      content: '';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid rgba(255, 255, 255, 0.7);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-align: center;
      min-width: 70px;
    }

    .status-pending {
      background: var(--pending-bg);
      color: var(--pending-text);
    }

    .status-applied {
      background: var(--applied-bg);
      color: var(--applied-text);
    }

    .status-sent-hr {
      background: var(--sent-hr-bg);
      color: var(--sent-hr-text);
    }

    .status-action-required {
      background: var(--action-required-bg);
      color: var(--action-required-text);
    }

    /* Reason Badge Styles */
    .reason-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .reason-sick-leave {
      background: var(--sick-leave-bg);
      color: var(--sick-leave-text);
    }

    .reason-no-out-card {
      background: var(--no-out-card-bg);
      color: var(--no-out-card-text);
    }

    .reason-duty-change {
      background: var(--duty-change-bg);
      color: var(--duty-change-text);
    }

    .reason-personal {
      background: var(--personal-bg);
      color: var(--personal-text);
    }

    .reason-training {
      background: var(--training-bg);
      color: var(--training-text);
    }

    .reason-other {
      background: #f0f0f0;
      color: #555;
    }

    .action-btn {
      padding: 6px 10px;
      border-radius: var(--radius);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .action-apply {
      background: var(--success);
      color: white;
    }

    .action-apply:hover {
      background: #218838;
    }

    .action-send-hr {
      background: var(--warning);
      color: white;
    }

    .action-send-hr:hover {
      background: #e0a800;
    }

    .action-sent-hr {
      background: var(--sent-hr-bg);
      color: var(--sent-hr-text);
      border: 1px solid var(--sent-hr-text);
    }

    .action-comment {
      background: var(--secondary);
      color: white;
      position: relative;
    }

    .action-comment:hover {
      background: #5a6268;
    }

    .comment-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-state {
      text-align: center;
      padding: 30px 15px;
      color: var(--secondary);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 12px;
      color: #dee2e6;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      padding: 15px;
      color: var(--secondary);
      font-size: 0.8rem;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .modal-header {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      background: #f8f9fa;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .comments-history {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }

    .comments-history h4 {
      margin-bottom: 10px;
      color: var(--dark);
    }

    .comment-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: var(--radius);
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .comment-item:last-child {
      margin-bottom: 0;
    }

    .comment-date {
      font-size: 0.7rem;
      color: var(--secondary);
      margin-top: 5px;
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* Alert Styles */
    .alert {
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .alert-success {
      background-color: #d1edff;
      border: 1px solid #b3d7ff;
      color: #0c5460;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
      .dashboard {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .filter-box {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
      }
      
      h1 {
        font-size: 1.7rem;
      }
      
      .dashboard {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Attendance Adjustment Records</h1>
      <p class="subtitle">View and manage all attendance adjustment requests</p>
    </header>

    <div id="firebaseAlert" class="alert alert-warning" style="display: none;">
      <i class="fas fa-exclamation-triangle"></i>
      <span id="alertMessage">Firebase connection issue. Using demo data.</span>
    </div>

    <div class="dashboard">
      <div class="stat-card total-requests">
        <div class="stat-value" id="totalRequests">0</div>
        <div class="stat-label">Total Requests</div>
      </div>
      <div class="stat-card pending-requests">
        <div class="stat-value" id="pendingRequests">0</div>
        <div class="stat-label">Pending Requests</div>
      </div>
      <div class="stat-card sent-hr-requests">
        <div class="stat-value" id="sentHrRequests">0</div>
        <div class="stat-label">Sent to HR</div>
      </div>
      <div class="stat-card applied-requests">
        <div class="stat-value" id="appliedRequests">0</div>
        <div class="stat-label">Applied Requests</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="fas fa-filter"></i> Filter Records
      </div>
      <div class="card-body">
        <div class="filter-box">
          <div class="filter-group">
            <label for="filterDate"><i class="fas fa-calendar-alt"></i> Date</label>
            <input type="date" id="filterDate">
          </div>
          <div class="filter-group">
            <label for="filterName"><i class="fas fa-user"></i> Name</label>
            <input type="text" id="filterName" placeholder="Filter by name (partial match)">
          </div>
          <div class="filter-group">
            <label for="filterRC"><i class="fas fa-id-card"></i> RC No</label>
            <input type="text" id="filterRC" placeholder="Filter by RC No">
          </div>
          <div class="filter-group">
            <label for="filterStatus"><i class="fas fa-tag"></i> Status</label>
            <select id="filterStatus">
              <option value="">All Statuses</option>
              <option value="Pending">Pending</option>
              <option value="Sent to HR">Sent to HR</option>
              <option value="Applied">Applied</option>
              <option value="Action Required">Action Required</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterReason"><i class="fas fa-sticky-note"></i> Reason</label>
            <select id="filterReason">
              <option value="">All Reasons</option>
              <option value="Sick Leave">Sick Leave</option>
              <option value="No Out Card">No Out Card</option>
              <option value="No In Card">No In Card</option>
              <option value="Duty Change">Duty Change</option>
              <option value="Personal Leave">Personal Leave</option>
              <option value="Fine Remove">Fine Remove</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="toggleApplied">
            <span class="toggle-slider"></span>
          </label>
          <span>Show Applied Records</span>
        </div>
        <div class="btn-group">
          <button id="btnFilter" class="btn-primary">
            <i class="fas fa-search"></i> Apply Filters
          </button>
          <button id="btnReset" class="btn-secondary">
            <i class="fas fa-redo"></i> Reset Filters
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="fas fa-table"></i> Adjustment Records
        <span id="recordCount" style="font-size: 0.8rem; margin-left: auto;">(0 records)</span>
      </div>
      <div class="card-body">
        <table id="adjustmentTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>RC No</th>
              <th>Date</th>
              <th>Reason</th>
              <th>Remarks</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="adjustmentBody">
            <!-- Data will be populated here -->
            <tr>
              <td colspan="7" class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No adjustment records found</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <footer>
      <p>Attendance Management System &copy; 2023</p>
    </footer>
  </div>

  <!-- Modal for adding user comments -->
  <div class="modal" id="commentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add User Comment</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filter-group">
          <label for="commentText">Your Comment</label>
          <textarea id="commentText" placeholder="Enter your comment here (e.g., MC needed, Additional documents required, etc.)"></textarea>
        </div>
        <div class="comments-history" id="commentHistory">
          <h4>Comment History</h4>
          <!-- Previous comments will be displayed here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelComment">Cancel</button>
        <button class="btn-primary" id="saveComment">Save Comment</button>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const filterDate = document.getElementById('filterDate');
    const filterName = document.getElementById('filterName');
    const filterRC = document.getElementById('filterRC');
    const filterStatus = document.getElementById('filterStatus');
    const filterReason = document.getElementById('filterReason');
    const toggleApplied = document.getElementById('toggleApplied');
    const btnFilter = document.getElementById('btnFilter');
    const btnReset = document.getElementById('btnReset');
    const adjustmentBody = document.getElementById('adjustmentBody');
    const recordCount = document.getElementById('recordCount');
    const totalRequests = document.getElementById('totalRequests');
    const pendingRequests = document.getElementById('pendingRequests');
    const appliedRequests = document.getElementById('appliedRequests');
    const sentHrRequests = document.getElementById('sentHrRequests');
    const firebaseAlert = document.getElementById('firebaseAlert');
    const alertMessage = document.getElementById('alertMessage');
    
    // Modal elements
    const commentModal = document.getElementById('commentModal');
    const commentText = document.getElementById('commentText');
    const commentHistory = document.getElementById('commentHistory');
    const saveComment = document.getElementById('saveComment');
    const cancelComment = document.getElementById('cancelComment');
    const closeModal = document.querySelector('.close-modal');

    // Global variables
    let allRecords = [];
    let filteredRecords = [];
    let currentCommentDocId = null;
    let currentFilters = {};
    let usingMockData = false;
    let db = null;

    // Check if Firebase is available
    function initializeFirebase() {
      try {
        if (window.cardDb) {
          db = window.cardDb;
          console.log("‚úÖ Using Firebase from fireatt.js");
          hideFirebaseAlert();
          return true;
        } else {
          throw new Error("Firebase not initialized in fireatt.js");
        }
      } catch (error) {
        console.error("‚ùå Firebase initialization error:", error);
        showFirebaseAlert("Firebase connection issue. Using demo data.");
        usingMockData = true;
        return false;
      }
    }

    // Mock data for demonstration when Firebase is not available
    const generateMockData = () => {
      const names = ["John Doe", "Jane Smith", "Robert Johnson", "Emily Davis", "Michael Wilson", "Sarah Brown", "David Miller", "Lisa Anderson"];
      const reasons = ["Sick Leave", "No Out Card", "No In Card", "Duty Change", "Personal Leave", "Training", "Fine Remove", "Other"];
      const statuses = ["Pending", "Applied", "Sent to HR", "Action Required"];
      
      const mockData = [];
      const today = new Date();
      
      for (let i = 0; i < 15; i++) {
        const randomDate = new Date();
        randomDate.setDate(today.getDate() - Math.floor(Math.random() * 30));
        
        const hasComments = Math.random() > 0.7;
        const userComments = hasComments ? [{
          text: "Please provide medical certificate",
          timestamp: new Date().toISOString(),
          user: "Manager"
        }] : [];

        mockData.push({
          id: `mock-${i}`,
          data: {
            name: names[Math.floor(Math.random() * names.length)],
            rcno: `RC${String(i+1).padStart(3, '0')}`,
            date: randomDate.toISOString().split('T')[0],
            reason: reasons[Math.floor(Math.random() * reasons.length)],
            remarks: "Sample remarks for demonstration",
            status: statuses[Math.floor(Math.random() * statuses.length)],
            userComments: userComments
          }
        });
      }
      
      return mockData;
    };

    // Get reason badge class
    function getReasonClass(reason) {
      switch(reason) {
        case 'Sick Leave': return 'reason-sick-leave';
        case 'No Out Card': return 'reason-no-out-card';
        case 'No In Card': return 'reason-no-out-card';
        case 'Duty Change': return 'reason-duty-change';
        case 'Personal Leave': return 'reason-personal';
        case 'Training': return 'reason-training';
        case 'Fine Remove': return 'reason-other';
        default: return 'reason-other';
      }
    }

    // Get status badge class
    function getStatusClass(status) {
      switch(status) {
        case 'Pending': return 'status-pending';
        case 'Applied': return 'status-applied';
        case 'Sent to HR': return 'status-sent-hr';
        case 'Action Required': return 'status-action-required';
        default: return 'status-pending';
      }
    }

    // Show/hide Firebase alert
    function showFirebaseAlert(message, isError = true) {
      if (isError) {
        firebaseAlert.className = 'alert alert-warning';
      } else {
        firebaseAlert.className = 'alert alert-success';
      }
      alertMessage.textContent = message;
      firebaseAlert.style.display = 'flex';
    }

    function hideFirebaseAlert() {
      firebaseAlert.style.display = 'none';
    }

    // Open comment modal
    function openCommentModal(docId) {
      currentCommentDocId = docId;
      
      // Clear comment text
      commentText.value = '';
      
      // Load and display comment history
      loadCommentHistory(docId);
      
      commentModal.style.display = 'flex';
    }

    // Load comment history
    async function loadCommentHistory(docId) {
      try {
        let data;
        
        if (usingMockData) {
          // For mock data, find the record
          const record = allRecords.find(r => r.id === docId);
          data = record ? record.data : {};
        } else {
          // For Firebase data
          const doc = await db.collection('AttendanceAdjustments').doc(docId).get();
          data = doc.data() || {};
        }
        
        commentHistory.innerHTML = '<h4>Comment History</h4>';
        
        if (!data.userComments || data.userComments.length === 0) {
          commentHistory.innerHTML += '<p>No comments yet.</p>';
          return;
        }
        
        data.userComments.forEach(comment => {
          const commentItem = document.createElement('div');
          commentItem.className = 'comment-item';
          commentItem.innerHTML = `
            <div><strong>${comment.user || 'User'}:</strong> ${comment.text}</div>
            <div class="comment-date">${new Date(comment.timestamp).toLocaleString()}</div>
          `;
          commentHistory.appendChild(commentItem);
        });
      } catch (error) {
        console.error('Error loading comments:', error);
        commentHistory.innerHTML = '<p>Error loading comments</p>';
      }
    }

    // Close comment modal
    function closeCommentModal() {
      commentModal.style.display = 'none';
      currentCommentDocId = null;
    }

    // Save comment
    saveComment.addEventListener('click', async function() {
      if (currentCommentDocId) {
        const newComment = commentText.value.trim();
        
        if (newComment) {
          try {
            if (usingMockData) {
              // Update mock data
              const record = allRecords.find(r => r.id === currentCommentDocId);
              if (record) {
                if (!record.data.userComments) {
                  record.data.userComments = [];
                }
                record.data.userComments.push({
                  text: newComment,
                  timestamp: new Date().toISOString(),
                  user: "Current User"
                });
                
                // If comment contains keywords, update status
                if (newComment.toLowerCase().includes('mc needed') || 
                    newComment.toLowerCase().includes('document') ||
                    newComment.toLowerCase().includes('action required')) {
                  record.data.status = 'Action Required';
                }
              }
            } else {
              // Update Firebase data
              const doc = await db.collection('AttendanceAdjustments').doc(currentCommentDocId).get();
              const currentData = doc.data();
              
              // Initialize userComments array if it doesn't exist
              const userComments = currentData.userComments || [];
              
              // Add new comment
              userComments.push({
                text: newComment,
                timestamp: new Date().toISOString(),
                user: "Current User"
              });
              
              // Update the document
              const updateData = { userComments: userComments };
              
              // If comment contains keywords, update status
              if (newComment.toLowerCase().includes('mc needed') || 
                  newComment.toLowerCase().includes('document') ||
                  newComment.toLowerCase().includes('action required')) {
                updateData.status = 'Action Required';
              }
              
              await db.collection('AttendanceAdjustments').doc(currentCommentDocId).update(updateData);
            }
            
            alert('‚úÖ Comment added successfully');
            loadRecords(currentFilters);
            closeCommentModal();
          } catch (error) {
            console.error('Error saving comment:', error);
            alert('‚ùå Error saving comment');
          }
        } else {
          alert('Please enter a comment before saving.');
        }
      }
    });

    // Cancel comment
    cancelComment.addEventListener('click', closeCommentModal);
    closeModal.addEventListener('click', closeCommentModal);

    // Load records from Firebase or use mock data
    async function loadRecords(filters = {}) {
      adjustmentBody.innerHTML = `<tr><td colspan='7' class="empty-state"><i class="fas fa-inbox"></i><p>‚è≥ Loading records...</p></td></tr>`;
      
      try {
        if (usingMockData || !db) {
          // Use mock data
          allRecords = generateMockData();
          console.log(`üìÑ Using ${allRecords.length} mock records`);
        } else {
          // Get records from Firebase
          const snapshot = await db.collection('AttendanceAdjustments').get();
          console.log(`üìÑ Found ${snapshot.size} records from Firebase`);

          if (snapshot.empty) {
            adjustmentBody.innerHTML = `<tr><td colspan='7' class="empty-state"><i class="fas fa-inbox"></i><p>No adjustment records found</p></td></tr>`;
            recordCount.textContent = '(0 records)';
            allRecords = [];
            filteredRecords = [];
            updateStats();
            return;
          }

          // Process Firebase records
          allRecords = [];
          snapshot.forEach(doc => {
            const d = doc.data();
            allRecords.push({ id: doc.id, data: d });
          });
        }

        // Apply filters
        applyFilters(filters);
        
      } catch (err) {
        console.error("‚ùå Error loading records:", err);
        // Fallback to mock data on error
        usingMockData = true;
        showFirebaseAlert("Error loading from Firebase. Using demo data.");
        allRecords = generateMockData();
        applyFilters(filters);
      }
    }

    // Apply filters to records
    function applyFilters(filters = {}) {
      filteredRecords = allRecords.filter(({ id, data: d }) => {
        let matches = true;

        // Apply filters
        if (filters.name) {
          const name = (d.name || d.Name || "").toLowerCase();
          if (!name.includes(filters.name.toLowerCase())) {
            matches = false;
          }
        }

        if (filters.rcno && matches) {
          const rcno = (d.rcno || d.RCNo || "").toLowerCase();
          if (!rcno.includes(filters.rcno.toLowerCase())) {
            matches = false;
          }
        }

        if (filters.date && matches) {
          const date = d.date || d.Date || "";
          if (date !== filters.date) {
            matches = false;
          }
        }

        if (filters.status && matches) {
          const status = d.status || d.Status || "Pending";
          if (status !== filters.status) {
            matches = false;
          }
        }

        if (filters.reason && matches) {
          const reason = d.reason || d.Reason || "";
          if (reason !== filters.reason) {
            matches = false;
          }
        }

        // Hide applied records by default unless toggle is on
        if (!toggleApplied.checked && matches) {
          const status = d.status || d.Status || "Pending";
          if (status === "Applied") {
            matches = false;
          }
        }

        return matches;
      });

      console.log(`üìÑ Displaying ${filteredRecords.length} filtered records`);
      renderTable();
      updateStats();
    }

    // Render table with data
    function renderTable() {
      adjustmentBody.innerHTML = '';
      recordCount.textContent = `(${filteredRecords.length} records)`;

      if (filteredRecords.length === 0) {
        adjustmentBody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>No adjustment records found</p>
            </td>
          </tr>
        `;
        return;
      }

      filteredRecords.forEach(({ id, data: d }) => {
        const name = d.name || d.Name || "";
        const rcno = d.rcno || d.RCNo || "";
        const date = d.date || d.Date || "";
        const reason = d.reason || d.Reason || "";
        const remarks = d.remarks || d.Remarks || "";
        const status = d.status || d.Status || "Pending";
        const userComments = d.userComments || [];

        // Determine which buttons to show based on status
        let actionButtons = '';
        
        if (status === 'Pending') {
          actionButtons = `
            <button class="action-btn action-apply" data-id="${id}">
              <i class="fas fa-check"></i> Apply
            </button>
            <button class="action-btn action-send-hr" data-id="${id}">
              <i class="fas fa-paper-plane"></i> Send to HR
            </button>
          `;
        } else if (status === 'Applied') {
          actionButtons = `
            <button class="action-btn action-apply" data-id="${id}" style="opacity: 0.6; cursor: not-allowed;">
              <i class="fas fa-check"></i> Applied
            </button>
          `;
        } else if (status === 'Sent to HR') {
          actionButtons = `
            <button class="action-btn action-apply" data-id="${id}">
              <i class="fas fa-check"></i> Apply
            </button>
            <button class="action-btn action-sent-hr" data-id="${id}">
              <i class="fas fa-paper-plane"></i> Sent to HR
            </button>
          `;
        } else if (status === 'Action Required') {
          actionButtons = `
            <button class="action-btn action-apply" data-id="${id}">
              <i class="fas fa-check"></i> Apply
            </button>
            <button class="action-btn action-send-hr" data-id="${id}">
              <i class="fas fa-paper-plane"></i> Send to HR
            </button>
          `;
        }

        // Add comment indicator if there are comments
        const commentIndicator = userComments && userComments.length > 0 
          ? `<span class="comment-indicator">${userComments.length}</span>` 
          : '';

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${name}</td>
          <td>${rcno}</td>
          <td>${date}</td>
          <td>
            <span class="reason-badge ${getReasonClass(reason)}">
              ${reason}
            </span>
          </td>
          <td>${remarks}</td>
          <td>
            <span class="status-badge ${getStatusClass(status)}">
              ${status}
            </span>
          </td>
          <td>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
              ${actionButtons}
              <button class="action-btn action-comment" data-id="${id}">
                <i class="fas fa-comment"></i> Comment
                ${commentIndicator}
              </button>
            </div>
          </td>
        `;
        adjustmentBody.appendChild(row);
      });

      // Attach button handlers
      document.querySelectorAll(".action-apply").forEach(btn => {
        if (!btn.style.opacity) { // Only add listener if not disabled
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            if (confirm('Are you sure you want to mark this request as applied?')) {
              if (usingMockData) {
                // Update mock data
                const record = allRecords.find(r => r.id === id);
                if (record) {
                  record.data.status = "Applied";
                }
              } else {
                // Update Firebase
                await db.collection('AttendanceAdjustments').doc(id).update({ status: "Applied" });
              }
              alert("‚úÖ Status updated to Applied");
              loadRecords(currentFilters);
            }
          });
        }
      });

      document.querySelectorAll(".action-send-hr").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if (confirm('Are you sure you want to send this request to HR for processing?')) {
            if (usingMockData) {
              // Update mock data
              const record = allRecords.find(r => r.id === id);
              if (record) {
                record.data.status = "Sent to HR";
              }
            } else {
              // Update Firebase
              await db.collection('AttendanceAdjustments').doc(id).update({ status: "Sent to HR" });
            }
            alert("üì§ Record sent to HR");
            loadRecords(currentFilters);
          }
        });
      });

      document.querySelectorAll(".action-comment").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          openCommentModal(id);
        });
      });
    }

    // Update statistics
    function updateStats() {
      if (totalRequests) totalRequests.textContent = allRecords.length;
      if (pendingRequests) pendingRequests.textContent = allRecords.filter(({ data: d }) => {
        const status = d.status || d.Status || "Pending";
        return status === "Pending" || status === "Action Required";
      }).length;
      if (appliedRequests) appliedRequests.textContent = allRecords.filter(({ data: d }) => {
        const status = d.status || d.Status || "Pending";
        return status === "Applied";
      }).length;
      if (sentHrRequests) sentHrRequests.textContent = allRecords.filter(({ data: d }) => {
        const status = d.status || d.Status || "Pending";
        return status === "Sent to HR";
      }).length;
    }

    // Initial load
    window.addEventListener("DOMContentLoaded", () => {
      console.log("üü¢ Viewer Page Loaded");
      
      // Initialize Firebase
      const firebaseReady = initializeFirebase();
      
      if (firebaseReady) {
        hideFirebaseAlert();
      } else {
        showFirebaseAlert("Firebase not configured. Using demo data.");
      }
      
      loadRecords();
    });

    // Filter handler
    btnFilter.addEventListener("click", () => {
      currentFilters = {
        name: filterName.value.trim(),
        rcno: filterRC.value.trim(),
        date: filterDate.value.trim(),
        status: filterStatus.value,
        reason: filterReason.value
      };
      applyFilters(currentFilters);
    });

    // Reset filters
    btnReset.addEventListener("click", () => {
      filterName.value = "";
      filterRC.value = "";
      filterDate.value = "";
      filterStatus.value = "";
      filterReason.value = "";
      currentFilters = {};
      applyFilters();
    });

    // Toggle applied records
    toggleApplied.addEventListener("change", () => {
      applyFilters(currentFilters);
    });
  </script>
</body>
</html>
